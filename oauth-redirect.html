<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FxLens OAuth redirect</title>
  <style>
    body{font-family:system-ui,Arial,Helvetica,sans-serif;display:flex;align-items:center;justify-content:center;height:100vh;margin:0}
    .wrap{max-width:520px;padding:20px;text-align:center}
    pre{white-space:pre-wrap;background:#f6f6f6;padding:8px;border-radius:6px}
    a.button{display:inline-block;margin-top:16px;padding:10px 14px;border-radius:8px;text-decoration:none;border:1px solid #ddd}
  </style>
</head>
<body>
  <div class="wrap">
    <h3>Redirecting…</h3>
    <div id="status">Trying to open the app. If nothing happens, use the link below.</div>
    <div id="debug" style="margin-top:12px"></div>
    <div id="fallback" style="margin-top:14px"></div>
  </div>

  <script>
  (function () {
    function parseParamsFrom(str) {
      try {
        const q = new URLSearchParams((str || '').replace(/^.*?[?#]/, ''));
        const userId = q.get('userId');
        const secret = q.get('secret');
        const error = q.get('error');
        return { userId, secret, error };
      } catch (e) {
        return { userId: null, secret: null };
      }
    }

    // Check search, hash, and full href for params
    const fromSearch = parseParamsFrom(window.location.search || '');
    const fromHash = parseParamsFrom(window.location.hash || '');
    const fromHref = parseParamsFrom(window.location.href || '');

    const userId = fromSearch.userId || fromHash.userId || fromHref.userId;
    const secret = fromSearch.secret || fromHash.secret || fromHref.secret;
    const error = fromSearch.error || fromHash.error || fromHref.error;

    const APP_SCHEME = 'appwrite-callback-6854257a000c3a519205://auth';
    // Also keep fxlens scheme fallback available:
    const ALT_SCHEME = 'fxlens://oauth';

    const debug = document.getElementById('debug');
    const status = document.getElementById('status');
    const fallback = document.getElementById('fallback');

    debug.innerHTML = '<pre>location.search: ' + encodeURI(window.location.search) +
                      '\\nlocation.hash: ' + encodeURI(window.location.hash) +
                      '\\nfull href: ' + encodeURI(window.location.href) + '</pre>';

    if (error) {
      status.textContent = 'OAuth error: ' + error;
    }

    if (userId && secret) {
      const target = APP_SCHEME + '?userId=' + encodeURIComponent(userId) + '&secret=' + encodeURIComponent(secret);
      const altTarget = ALT_SCHEME + '?userId=' + encodeURIComponent(userId) + '&secret=' + encodeURIComponent(secret);

      // Try immediate replace (preferred)
      try {
        window.location.replace(target);
      } catch (e) {}

      // Also try setting href after tiny delay (some browsers need it)
      setTimeout(function() {
        try { window.location.href = target; } catch(e) {}
      }, 200);

      // Android intent fallback (some Android browsers allow intent scheme)
      setTimeout(function() {
        try {
          const intentUrl = 'intent://' + target.replace(/^[^:]+:\/\//,'') + '#Intent;scheme=' + target.split(':')[0] + ';package=com.danieldon.fxlens;end';
          window.location.href = intentUrl;
        } catch(e) {}
      }, 600);

      // clickable fallback
      fallback.innerHTML = '<p>If you are not redirected automatically, <a class="button" href="' + target + '">Open FxLens</a></p>' +
                           '<p>Alternative: <a class="button" href="' + altTarget + '">Open FxLens (alternate)</a></p>';
      status.textContent = 'Redirecting to app…';
    } else {
      status.textContent = 'Missing userId/secret in redirect. Click the button to open app and debug.';
      fallback.innerHTML = '<p><a class="button" href="' + APP_SCHEME + '">Open FxLens</a></p>' +
                           '<p>If you don’t see parameters in the previous box, check that Appwrite is including them in the redirect to this page.</p>';
    }
  })();
  </script>
</body>
</html>
